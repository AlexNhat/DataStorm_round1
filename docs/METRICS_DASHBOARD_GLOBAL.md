# Metrics Dashboard (GLOBAL)

## Overview
- Metrics data comes from `results/metrics/global_dashboard_metrics.json`, generated by `scripts/generate_dashboard_metrics.py`.
- Source features are derived from `data/merged/supplychain_weather_merged_global.csv` so every KPI reflects the same GLOBAL dataset as the production models.
- Snapshot JSON is treated as the single source of truth for the dashboard and `/api/models/metrics/global` endpoint.

## Generation Workflow
1. Run `python scripts/generate_dashboard_metrics.py --summary results/metrics/global_dashboard_metrics.json`.
2. Script aggregates per-model metrics, builds heatmaps/reward curves, and writes:
   - `results/metrics/global_dashboard_metrics.json`
   - `results/metrics/snapshots/YYYY-MM-DD/global_dashboard_metrics.json`
3. Routers (`app/routers/models_metrics.py`) load the JSON for API + HTML templates.

## API & Routes
- `GET /api/models/metrics/global` → raw JSON summary for automation/testing.
- `GET /dashboard/metrics` → overview UI (`dashboard/metrics/metrics_overview.html`).
- `GET /dashboard/metrics/<slug>` → detail views: inventory-rl, forecast, delivery, pricing.

## Templates & Components
- All templates extend `base.html`, use Tailwind utility classes, and reuse components:
  - Cards (`components/card.html`)
  - Chart containers (`components/chart_block.html`)
  - Table + badge utilities when needed
- JS visualizations rely on Chart.js (loaded globally in `base.html`).
- Heatmaps (pricing) use progressive color fills calculated client-side for readability.

## Data Contract (summary JSON)
```
{
  "generated_at": "ISO timestamp",
  "inventory_rl": {
      "accuracy": float,
      "reward_curve": [float],
      "region_performance": {"REGION": value}
  },
  "forecast": {
      "scopes": [{"scope": str, "mae": float}],
      "horizon": [{"record_date": str, "Sales": float}]
  },
  "late_delivery": {
      "accuracy": float,
      "f1": float,
      "precision": float,
      "recall": float,
      "region_delay": {"REGION": float}
  },
  "pricing": {
      "mae": float,
      "heatmap_regions": [str],
      "heatmap_categories": [str],
      "heatmap": [[float]]
  }
}
```

## Validation Checklist
- Ensure `generate_dashboard_metrics.py` runs before deploying UI changes.
- Confirm JSON timestamps and metrics align with the latest training jobs.
- Hit `/api/models/metrics/global` to verify schema before loading UI.
- Load `/dashboard/metrics` plus each detail page to confirm charts render without console errors.

## Troubleshooting
- If the API returns 500 → rerun the metrics script or inspect JSON syntax.
- Missing Chart.js visuals → check Tailwind/JS caching and confirm `summary` is passed to templates.
- Outdated numbers → delete stale snapshot files and regenerate metrics to avoid reading cached values.
