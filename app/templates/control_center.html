{% extends "base.html" %}

{% block title %}OS Control Center{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
    .glass-panel {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 24px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.07);
    }
    .kpi-card {
        border-radius: 20px;
        border: 1px solid rgba(226, 232, 240, 0.8);
        padding: 18px 20px;
        background: #fff;
        transition: transform 0.15s ease;
    }
    .kpi-card:hover { transform: translateY(-4px); }
    .kpi-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    .timeline-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .timeline-line {
        width: 2px;
        flex: 1;
        background: rgba(148, 163, 184, 0.4);
        margin-top: 4px;
    }
    .action-card {
        border-radius: 24px;
        border: 1px solid rgba(226, 232, 240, 0.9);
        background: #fff;
        padding: 24px;
        box-shadow: 0 25px 40px rgba(15, 23, 42, 0.08);
    }
</style>
{% endblock %}

{% block content %}
<div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-40 backdrop-blur-sm z-40 hidden items-center justify-center">
    <div class="bg-white rounded-3xl px-8 py-6 text-center shadow-xl">
        <div class="h-12 w-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-600 text-sm">Đang tải dữ liệu mới nhất...</p>
    </div>
</div>

<div id="success-toast" class="hidden fixed top-6 right-6 bg-emerald-500 text-white px-6 py-3 rounded-2xl shadow-lg text-sm font-semibold z-40">
    <span id="success-message"></span>
    <button class="ml-4" onclick="document.getElementById('success-toast').classList.add('hidden')">&times;</button>
</div>
<div id="error-toast" class="hidden fixed top-6 right-6 bg-rose-500 text-white px-6 py-3 rounded-2xl shadow-lg text-sm font-semibold z-40">
    <span id="error-message"></span>
    <button class="ml-4" onclick="document.getElementById('error-toast').classList.add('hidden')">&times;</button>
</div>

<section class="glass-panel p-6 mb-6 flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
    <div class="max-w-2xl">
        <p class="text-xs uppercase tracking-[0.35em] text-slate-400 mb-2">Operating System</p>
        <h1 class="text-3xl font-semibold text-slate-900 mb-2">Control Center</h1>
        <p class="text-sm text-slate-500">Theo dõi các action AI, kiểm soát chế độ vận hành và duyệt hành động quan trọng.</p>
    </div>
    <div id="os-status" class="text-right">
        <p class="text-xs text-slate-400">OS Status</p>
        <p class="text-lg font-semibold text-emerald-600">Đang khởi tạo...</p>
    </div>
</section>

<section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="kpi-card">
        <p class="text-xs text-slate-400 uppercase">Action chờ duyệt</p>
        <p class="text-2xl font-semibold text-slate-900 mt-2" id="kpi-pending-count">--</p>
        <p class="text-xs text-slate-400 mt-1">AI đang đợi bạn xác nhận</p>
    </div>
    <div class="kpi-card">
        <p class="text-xs text-slate-400 uppercase">Tỉ lệ tự động</p>
        <p class="text-2xl font-semibold text-slate-900 mt-2">72%</p>
        <p class="text-xs text-slate-400 mt-1">Action auto-applied tuần này</p>
    </div>
    <div class="kpi-card">
        <p="text-xs text-slate-400 uppercase">Vi phạm policy</p>
        <p class="text-2xl font-semibold text-slate-900 mt-2">2</p>
        <p class="text-xs text-slate-400 mt-1">Cần rà soát ngay</p>
    </div>
    <div class="kpi-card">
        <p class="text-xs text-slate-400 uppercase">Khuyến nghị mới</p>
        <p class="text-2xl font-semibold text-slate-900 mt-2">5</p>
        <p class="text-xs text-slate-400 mt-1">Chưa gửi sang Control Tower</p>
    </div>
</section>

<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
    <section class="glass-panel p-6 space-y-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-slate-400 uppercase">Chế độ vận hành</p>
                <h2 class="text-xl font-semibold text-slate-900">Autonomous Mode</h2>
            </div>
            <div class="flex items-center gap-3">
                <select id="mode-selector" class="border border-slate-200 rounded-2xl px-4 py-2 text-sm font-semibold text-slate-700">
                    <option value="advisory">Level 1: Advisory</option>
                    <option value="hybrid" selected>Level 2: Hybrid</option>
                    <option value="autonomous">Level 3: Full Auto</option>
                </select>
                <button id="btn-save-mode" class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-blue-500 transition">Lưu</button>
            </div>
        </div>
        <div id="mode-description" class="p-4 rounded-2xl bg-slate-50 border border-slate-100 text-sm text-slate-600">
            <p id="mode-desc-text"><strong>Hybrid Mode:</strong> AI tự xử lý vùng an toàn, action rủi ro sẽ chờ bạn phê duyệt.</p>
        </div>
    </section>

    <section class="glass-panel p-6 space-y-4">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold text-slate-900">Bộ lọc hành động</h2>
            <div class="flex gap-2">
                <button id="btn-apply-filter" class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-blue-500">Áp dụng</button>
                <button id="btn-reset-filter" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-slate-200">Đặt lại</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="text-xs uppercase text-slate-400">Trạng thái</label>
                <select id="filter-status" class="mt-1 w-full border border-slate-200 rounded-2xl px-3 py-2 text-sm">
                    <option value="">Tất cả</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="auto-applied">Auto-Applied</option>
                </select>
            </div>
            <div>
                <label class="text-xs uppercase text-slate-400">Loại action</label>
                <select id="filter-type" class="mt-1 w-full border border-slate-200 rounded-2xl px-3 py-2 text-sm">
                    <option value="">Tất cả</option>
                    <option value="increase_inventory">Tăng tồn kho</option>
                    <option value="decrease_inventory">Giảm tồn kho</option>
                    <option value="prioritize_vip">Ưu tiên VIP</option>
                    <option value="redistribute_inventory">Phân bổ</option>
                </select>
            </div>
            <div>
                <label class="text-xs uppercase text-slate-400">Ngân sách</label>
                <select id="filter-cost" class="mt-1 w-full border border-slate-200 rounded-2xl px-3 py-2 text-sm">
                    <option value="">Tất cả</option>
                    <option value="low">&lt; $10k</option>
                    <option value="medium">$10k - $50k</option>
                    <option value="high">&gt; $50k</option>
                </select>
            </div>
            <div>
                <label class="text-xs uppercase text-slate-400">Độ tin cậy</label>
                <select id="filter-confidence" class="mt-1 w-full border border-slate-200 rounded-2xl px-3 py-2 text-sm">
                    <option value="">Tất cả</option>
                    <option value="high">&gt; 80%</option>
                    <option value="medium">60% - 80%</option>
                    <option value="low">&lt; 60%</option>
                </select>
            </div>
        </div>
    </section>
</div>

<div class="grid grid-cols-1 2xl:grid-cols-3 gap-6">
    <section class="2xl:col-span-2 glass-panel p-6 space-y-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs uppercase text-slate-400">Queue</p>
                <h2 class="text-xl font-semibold text-slate-900">Pending Actions</h2>
            </div>
            <button id="btn-refresh" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-slate-200">Refresh</button>
        </div>
        <div id="pending-actions-list" class="space-y-4"></div>
        <div id="no-pending" class="text-center py-10 text-slate-400 hidden">
            <p class="text-lg font-semibold">Không có action nào đang chờ.</p>
            <p class="text-sm">Tạo chiến lược mới hoặc quay lại sau.</p>
        </div>
    </section>

    <section class="glass-panel p-6 space-y-5">
        <div>
            <p class="text-xs uppercase text-slate-400">Timeline</p>
            <h2 class="text-xl font-semibold text-slate-900">Lịch sử actions</h2>
        </div>
        <div id="action-history-list" class="space-y-5 overflow-y-auto max-h-[380px] pr-2"></div>
        <div id="no-history" class="text-center py-6 text-slate-400 hidden">
            <p class="text-sm">Chưa có lịch sử hành động.</p>
        </div>
        <div class="grid grid-cols-1 gap-4">
            <div class="glass-panel p-4">
                <h3 class="text-sm font-semibold text-slate-700 mb-2">Action theo giờ</h3>
                <canvas id="history-line-chart" height="140"></canvas>
            </div>
            <div class="glass-panel p-4">
                <h3 class="text-sm font-semibold text-slate-700 mb-2">Biểu đồ theo loại</h3>
                <canvas id="history-type-chart" height="140"></canvas>
            </div>
        </div>
    </section>
</div>

<div id="action-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white rounded-3xl p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto shadow-2xl">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-slate-900">Chi tiết hành động</h3>
            <button onclick="closeActionModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
        </div>
        <div id="action-modal-content"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentMode = 'hybrid';
let pendingActions = [];
let actionHistory = [];
let selectedAction = null;
let historyCharts = { line: null, type: null };

document.addEventListener('DOMContentLoaded', () => {
    loadOSStatus();
    loadPendingActions();
    loadActionHistory();
    setupModeSelector();
    setupFilters();
});

async function loadOSStatus() {
    try {
        const response = await fetch('/os/status');
        const data = await response.json();
        const statusDiv = document.getElementById('os-status');
        if (data.running) {
            statusDiv.innerHTML = `
                <p class="text-xs text-slate-400 uppercase">OS Status</p>
                <p class="text-lg font-semibold text-emerald-600 flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span> Đang chạy</p>
                <p class="text-xs text-slate-400">${data.total_tasks || 0} tác vụ đăng ký</p>
            `;
        } else {
            statusDiv.innerHTML = `
                <p class="text-xs text-slate-400 uppercase">OS Status</p>
                <p class="text-lg font-semibold text-rose-600">Đang dừng</p>
            `;
        }
    } catch (error) {
        console.error('Error loading OS status:', error);
    }
}

async function loadPendingActions() {
    const overlay = document.getElementById('loading-overlay');
    overlay.classList.remove('hidden');
    try {
        const response = await fetch('/os/actions/pending');
        const data = await response.json();
        pendingActions = data.pending_actions || [];
        document.getElementById('kpi-pending-count').textContent = pendingActions.length.toString().padStart(2, '0');
        displayPendingActions(pendingActions);
    } catch (error) {
        console.error('Error loading pending actions:', error);
        showErrorToast('Không thể tải pending actions: ' + error.message);
    } finally {
        overlay.classList.add('hidden');
    }
}

function displayPendingActions(actions) {
    const list = document.getElementById('pending-actions-list');
    const empty = document.getElementById('no-pending');
    if (!actions.length) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }
    empty.classList.add('hidden');
    list.innerHTML = actions.map((action, index) => `
        <div class="action-card">
            <div class="flex flex-col gap-4">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="kpi-badge bg-amber-100 text-amber-700">${action.priority || 'normal'}</span>
                            <span class="text-xs text-slate-500">${action.id}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900">${action.title || action.type}</h3>
                        <p class="text-sm text-slate-500 mt-1">${action.description || ''}</p>
                    </div>
                    <div class="text-right text-sm text-slate-500">
                        <p>Ước tính: <span class="font-semibold text-slate-900">$${action.estimated_cost?.toLocaleString() || 'N/A'}</span></p>
                        <p>Độ tin cậy: <span class="font-semibold text-slate-900">${action.confidence ? (action.confidence * 100).toFixed(0) + '%' : 'N/A'}</span></p>
                        <p>${action.created_at ? new Date(action.created_at).toLocaleString('vi-VN') : ''}</p>
                    </div>
                </div>
                <div class="text-sm text-slate-500 bg-slate-50 border border-slate-100 rounded-2xl p-4">
                    <p class="font-semibold text-slate-700">Reasoning</p>
                    <p class="mt-1">${action.reasoning || 'Không có reasoning'}</p>
                </div>
                ${action.policy_check ? `
                    <div class="text-sm rounded-2xl border ${action.policy_check.compliant ? 'border-emerald-100 bg-emerald-50' : 'border-amber-100 bg-amber-50'} p-4">
                        <p class="font-semibold mb-1">${action.policy_check.compliant ? 'Policy compliant' : 'Cần xem xét policy'}</p>
                        ${action.policy_check.violations && action.policy_check.violations.length ? `
                            <ul class="list-disc list-inside text-slate-600">
                                ${action.policy_check.violations.map(v => `<li>${v.message || v.code}</li>`).join('')}
                            </ul>` : '<p class="text-slate-600">Không có vi phạm.</p>'}
                    </div>
                ` : ''}
                <div class="flex flex-wrap gap-3">
                    <button onclick="viewActionDetails('${action.id || index}')" class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-blue-500">Chi tiết & phê duyệt</button>
                </div>
            </div>
        </div>
    `).join('');
}

async function loadActionHistory() {
    try {
        const response = await fetch('/os/action/history');
        const data = await response.json();
        actionHistory = data.history || [];
        displayActionHistory(actionHistory);
        renderHistoryCharts(data.aggregations || {});
    } catch (error) {
        console.error('Error loading action history:', error);
        showErrorToast('Không thể tải action history: ' + error.message);
    }
}

function displayActionHistory(history) {
    const list = document.getElementById('action-history-list');
    const empty = document.getElementById('no-history');
    if (!history.length) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }
    empty.classList.add('hidden');
    const statusMap = {
        'auto-applied': 'bg-blue-100 text-blue-700',
        'approved': 'bg-emerald-100 text-emerald-700',
        'rejected': 'bg-rose-100 text-rose-700'
    };
    const dotMap = {
        'auto-applied': 'bg-blue-500',
        'approved': 'bg-emerald-500',
        'rejected': 'bg-rose-500'
    };
    list.innerHTML = history.map((item, idx) => `
        <div class="flex gap-4">
            <div class="flex flex-col items-center">
                <span class="timeline-dot ${dotMap[item.status] || 'bg-slate-400'}"></span>
                ${idx === history.length - 1 ? '' : '<span class="timeline-line"></span>'}
            </div>
            <div class="flex-1 bg-white border border-slate-100 rounded-2xl px-4 py-3 shadow-sm">
                <div class="flex items-center justify-between text-xs text-slate-400">
                    <span>${item.timestamp ? new Date(item.timestamp).toLocaleString('vi-VN') : ''}</span>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusMap[item.status] || 'bg-slate-100 text-slate-700'}">${item.status}</span>
                </div>
                <p class="text-sm text-slate-700 mt-1">${item.summary}</p>
                <p class="text-xs text-slate-500 mt-1">Người thực hiện: ${item.actor || 'AI'}</p>
                ${item.result ? `<p class="text-xs text-slate-500 mt-1">${item.result}</p>` : ''}
                ${item.confidence ? `<p class="text-xs text-slate-400 mt-1">Độ tin cậy: ${(item.confidence * 100).toFixed(0)}%</p>` : ''}
            </div>
        </div>
    `).join('');
}

function renderHistoryCharts(aggregations) {
    if (!window.Chart) return;
    const lineCtx = document.getElementById('history-line-chart');
    const typeCtx = document.getElementById('history-type-chart');
    if (!lineCtx || !typeCtx) return;
    const byHour = aggregations.by_hour || [];
    const labels = byHour.map(item => new Date(item.bucket).toLocaleTimeString('vi-VN', { hour: '2-digit' }));
    const dataApproved = byHour.map(item => item.approved);
    const dataRejected = byHour.map(item => item.rejected);
    const dataAuto = byHour.map(item => item.auto);
    if (historyCharts.line) historyCharts.line.destroy();
    historyCharts.line = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                { label: 'Approved', data: dataApproved, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.35 },
                { label: 'Rejected', data: dataRejected, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.35 },
                { label: 'Auto', data: dataAuto, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.35 }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
    });
    const byType = aggregations.by_type || [];
    const typeLabels = byType.map(item => item.type);
    const typeCounts = byType.map(item => item.count);
    if (historyCharts.type) historyCharts.type.destroy();
    historyCharts.type = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: typeLabels,
            datasets: [{
                data: typeCounts,
                backgroundColor: ['#3b82f6', '#f97316', '#10b981', '#facc15', '#6366f1']
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
}

function setupModeSelector() {
    const selector = document.getElementById('mode-selector');
    const descText = document.getElementById('mode-desc-text');
    const descriptions = {
        advisory: '<strong>Advisory Mode:</strong> AI chỉ đề xuất, mọi action cần duyệt.',
        hybrid: '<strong>Hybrid Mode:</strong> AI tự xử lý vùng an toàn, action quan trọng cần duyệt.',
        autonomous: '<strong>Full Auto:</strong> AI được phép hành động toàn diện trong phạm vi policy.'
    };
    selector.addEventListener('change', (e) => {
        currentMode = e.target.value;
        descText.innerHTML = descriptions[currentMode];
    });
    document.getElementById('btn-save-mode').addEventListener('click', () => {
        showSuccessToast(`Đã chuyển sang ${currentMode} mode`);
    });
}

function setupFilters() {
    document.getElementById('btn-apply-filter').addEventListener('click', applyFilters);
    document.getElementById('btn-reset-filter').addEventListener('click', () => {
        resetFilters();
        loadPendingActions();
    });
    document.getElementById('btn-refresh').addEventListener('click', () => {
        loadPendingActions();
        loadActionHistory();
    });
}

function applyFilters() {
    const status = document.getElementById('filter-status').value;
    const type = document.getElementById('filter-type').value;
    const cost = document.getElementById('filter-cost').value;
    const confidence = document.getElementById('filter-confidence').value;
    let filtered = [...pendingActions];
    if (status) filtered = filtered.filter(a => a.status === status);
    if (type) filtered = filtered.filter(a => a.type === type);
    if (cost) {
        filtered = filtered.filter(a => {
            const value = a.estimated_cost || 0;
            if (cost === 'low') return value < 10000;
            if (cost === 'medium') return value >= 10000 && value <= 50000;
            if (cost === 'high') return value > 50000;
            return true;
        });
    }
    if (confidence) {
        filtered = filtered.filter(a => {
            const conf = a.confidence || 0;
            if (confidence === 'high') return conf > 0.8;
            if (confidence === 'medium') return conf >= 0.6 && conf <= 0.8;
            if (confidence === 'low') return conf < 0.6;
            return true;
        });
    }
    displayPendingActions(filtered);
}

function resetFilters() {
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-cost').value = '';
    document.getElementById('filter-confidence').value = '';
}

function viewActionDetails(actionId) {
    const action = pendingActions.find(a => (a.id || '') === actionId);
    if (!action) {
        showErrorToast('Không tìm thấy action.');
        return;
    }
    selectedAction = action;
    const modal = document.getElementById('action-modal');
    const content = document.getElementById('action-modal-content');
    content.innerHTML = `
        <div class="space-y-4 text-sm text-slate-600">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs uppercase text-slate-400">Action</p>
                    <p class="text-lg font-semibold text-slate-900">${action.title || action.type}</p>
                    <p class="text-xs text-slate-400 mt-1">${action.id}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs uppercase text-slate-400">Priority</p>
                    <p class="text-sm font-semibold text-slate-900">${action.priority || 'normal'}</p>
                </div>
            </div>
            <div>
                <p class="text-xs uppercase text-slate-400">Mô tả</p>
                <p>${action.description || 'Không có mô tả'}</p>
            </div>
            <div>
                <p class="text-xs uppercase text-slate-400">Reasoning</p>
                <p>${action.reasoning || 'Không có reasoning'}</p>
            </div>
            <div>
                <p class="text-xs uppercase text-slate-400">Policy Check</p>
                <pre class="bg-slate-50 border border-slate-100 rounded-2xl p-3 overflow-auto text-xs">${JSON.stringify(action.policy_check || {}, null, 2)}</pre>
            </div>
            <div>
                <p class="text-xs uppercase text-slate-400">Payload</p>
                <pre class="bg-slate-50 border border-slate-100 rounded-2xl p-3 overflow-auto text-xs">${JSON.stringify(action.payload || {}, null, 2)}</pre>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-xs uppercase text-slate-400">Ghi chú phê duyệt</label>
                    <textarea id="approve-notes" class="mt-1 w-full border border-slate-200 rounded-2xl px-3 py-2" rows="2" placeholder="Nhập ghi chú (nếu có)"></textarea>
                </div>
                <div>
                    <label class="text-xs uppercase text-slate-400">Lý do từ chối</label>
                    <textarea id="reject-reason" class="mt-1 w-full border border-slate-200 rounded-2xl px-3 py-2" rows="2" placeholder="Nhập lý do nếu từ chối"></textarea>
                </div>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="submitActionDecision('approve')" class="bg-emerald-500 text-white px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-emerald-400">Phê duyệt</button>
                <button onclick="submitActionDecision('reject')" class="bg-rose-500 text-white px-4 py-2 rounded-2xl text-sm font-semibold hover:bg-rose-400">Từ chối</button>
            </div>
        </div>
    `;
    modal.classList.remove('hidden');
}

function closeActionModal() {
    selectedAction = null;
    document.getElementById('action-modal').classList.add('hidden');
}

async function submitActionDecision(decision) {
    if (!selectedAction) return;
    const approveNotes = document.getElementById('approve-notes').value;
    const rejectReason = document.getElementById('reject-reason').value;
    const endpoint = decision === 'approve' ? '/os/actions/approve' : '/os/actions/reject';
    const payload = decision === 'approve'
        ? { action_id: selectedAction.id, approved_by: 'user_001', notes: approveNotes }
        : { action_id: selectedAction.id, rejected_by: 'user_001', reason: rejectReason, notes: approveNotes };
    if (decision === 'reject' && !rejectReason.trim()) {
        showErrorToast('Vui lòng nhập lý do từ chối.');
        return;
    }
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (data.status !== 'success') {
            throw new Error(data.message || 'Action failed');
        }
        showSuccessToast(data.message || 'Thao tác thành công');
        closeActionModal();
        await loadPendingActions();
        await loadActionHistory();
    } catch (error) {
        console.error('Error submitting action decision:', error);
        showErrorToast('Lỗi xử lý action: ' + error.message);
    }
}

function showSuccessToast(message) {
    const toast = document.getElementById('success-toast');
    document.getElementById('success-message').textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 4000);
}

function showErrorToast(message) {
    const toast = document.getElementById('error-toast');
    document.getElementById('error-message').textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 4000);
}
</script>
{% endblock %}
